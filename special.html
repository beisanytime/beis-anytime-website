<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Shiurim  - Beis Anytime</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div class="site-wrapper">
    <aside class="sidebar">
        <div class="sidebar-logo">
            <a href="../index.html">
                <img src="../images/logo.png" alt="Beis Anytime Logo" class="logo-full">
                <img src="../images/logo-icon-placeholder.png" alt="Beis Anytime" class="logo-icon">
            </a>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="../index.html"><i class="fas fa-home"></i> <span class="nav-text">Home</span></a></li>
                <li><a href="../recent.html"><i class="fas fa-clock"></i> <span class="nav-text">Recent</span></a></li>
                <li><a href="../trending.html"><i class="fas fa-fire"></i> <span class="nav-text">Trending</span></a></li>
            </ul>
            <p class="nav-section-title">BROWSE</p>
            <ul>
                <li><a href="#"><i class="fas fa-bookmark"></i> <span class="nav-text">Topics</span></a></li>
                <li><a href="../speakers.html"><i class="fas fa-user-friends"></i> <span class="nav-text">Speakers</span></a></li>
            </ul>
        </nav>
    </aside>

    <div class="main-content">

    <header class="site-header">
        <div class="search-bar">
             <i class="fas fa-search"></i>
            <input type="search" placeholder="Search TorahAnytime">
        </div>
        
        <div class="header-right">
            <div class="theme-toggle" id="themeToggleWrap" aria-hidden="false">
                <button id="themeToggleBtn" aria-label="Toggle dark mode" title="Toggle dark mode">
                    <span class="thumb" id="themeThumb"></span>
                </button>
            </div>

            <div class="header-dropdown" id="headerDropdown">
                <button class="dropdown-toggle" id="dropdownToggleBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item" id="donateBtn"><i class="fas fa-hand-holding-heart"></i> Donate</a>
                    <a href="#" class="dropdown-item" id="notificationBell">
                        <i class="fas fa-bell"></i> Notifications
                    </a>

                    <!-- DYNAMIC LOGIN/USER SECTION -->
                    <div id="googleLoginBtn" class="google-login-btn"></div>
                    
                    <a href="../account.html" class="dropdown-item user-info" style="display:none;">
                        <img src="" alt="User" class="user-avatar">
                        <span class="user-name"></span>
                    </a>
                    <a href="#" class="dropdown-item sign-out-btn" style="display:none;">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </a>
                    <!-- END DYNAMIC SECTION -->
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="rabbi-hero" style="background-image: url('../images/special_.png');">
            <div class="rabbi-hero-content">
                <h1>Special Shiurim</h1>
            </div>
        </section>

        <!-- Section 1: Shiurim Grid (Visible by default) -->
        <section class="shiurim-section" id="shiurimSection">
            <div class="container">
                <div class="shiur-grid" id="shiurimGrid">
                    <!-- Initial loading message, replaced by content after fetch -->
                    <p class="loading-message">Loading shiurim...</p>
                </div>
            </div>
        </section>

        <!-- Section 2: Upload Form (Hidden by default) -->
        <section class="upload-section" id="uploadSection">
            <div class="container">
                 <div class="upload-container">
                    <h1>Upload a Shiur</h1>
                    
                    <!-- Main Details & File Upload (Left Column) -->
                    <div class="upload-main-details">
                        <div class="input-group">
                            <label for="title">Title</label>
                            <input type="text" id="title" placeholder="e.g., Parashas Ki Savo" required>
                        </div>

                        <div class="input-group">
                            <label for="description">Description (Optional)</label>
                            <textarea id="description" placeholder="A brief summary..."></textarea>
                        </div>
                    </div>

                    <!-- File & Thumbnail (Right Column) -->
                    <div class="upload-side-details">
                        <div class="file-drop-zone" id="dropZone">
                            <span class="file-drop-zone-icon">▲</span>
                            <p id="dropZoneText">Drag & drop video/audio file here</p>
                            <span>or click to browse</span>
                            <p id="fileName"></p>
                            <!-- Image tag to display the generated thumbnail -->
                            <img id="thumbnailPreview" src="" alt="Video thumbnail preview" style="display: none;">
                        </div>
                        <input type="file" id="fileInput" accept="video/*,audio/*" style="display: none;">
                        
                        <!-- Thumbnail Scrubber Controls -->
                        <div id="thumbnailScrubberControls" class="thumbnail-controls" style="display: none;">
                            <button id="prevFrameBtn"> &lt; </button>
                            <input type="range" id="videoScrubber" min="0" max="100" value="0" step="0.1">
                            <button id="nextFrameBtn"> &gt; </button>
                        </div>
                    </div>

                    <!-- Full Width: Notes -->
                    <div class="upload-full-width">
                        <div class="input-group">
                            <label for="notes">Notes (Optional)</label>
                            <textarea id="notes" placeholder="Paste in notes or sources..."></textarea>
                        </div>
                    </div>

                    <!-- Metadata (Date, Uploader) -->
                    <div class="upload-full-width upload-meta" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="input-group">
                            <label for="date">Date</label>
                            <input type="date" id="date">
                        </div>
                        <div class="input-group">
                            <label for="uploaderName">Uploaded By</label>
                            <input type="text" id="uploaderName" placeholder="Your Name">
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="upload-actions">
                        <button class="cancel-button" id="cancelBtn">Cancel</button>
                        <button class="upload-button" id="uploadBtn">Upload Shiur</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Password Modal -->
        <div class="modal-overlay hidden" id="passwordModalOverlay">
            <div class="modal-content">
                <h2>Enter Password to Upload</h2>
                <p>Please enter the password to access the upload form.</p>
                <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
                <div id="passwordError" class="password-error-message">Incorrect password. Please try again.</div>
                <button id="passwordSubmitBtn">Submit</button>
            </div>
        </div>

    </main>
    </div> <!-- .main-content -->
    </div> <!-- .site-wrapper -->
    
    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2025 Beis Anytime. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Hidden elements for video thumbnail processing (off-screen) -->
    <video id="video-processor" muted preload="metadata" style="display: none;"></video>
    <canvas id="canvas-processor" style="display: none;"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const workerURL = 'https://beis-anytime-api.beisanytime.workers.dev'; // Your Cloudflare Worker URL

            // --- UI ELEMENT SELECTIONS ---
            const shiurimSection = document.getElementById('shiurimSection');
            const uploadSection = document.getElementById('uploadSection');
            const shiurimGrid = document.getElementById('shiurimGrid'); 
            const uploadBtn = document.getElementById('uploadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const fileInput = document.getElementById('fileInput');
            const dateInput = document.getElementById('date');
            const uploaderNameInput = document.getElementById('uploaderName');
            const dropZone = document.getElementById('dropZone');
            const fileNameDisplay = document.getElementById('fileName');
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const notesInput = document.getElementById('notes');
            
            // Password Modal Elements
            const passwordModalOverlay = document.getElementById('passwordModalOverlay');
            const passwordInput = document.getElementById('passwordInput');
            const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
            const passwordError = document.getElementById('passwordError');

            // Elements for thumbnail generation
            const videoProcessor = document.getElementById('video-processor');
            const canvasProcessor = document.getElementById('canvas-processor');
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            const dropZoneText = document.getElementById('dropZoneText');

            // Thumbnail scrubber controls
            const thumbnailScrubberControls = document.getElementById('thumbnailScrubberControls');
            const videoScrubber = document.getElementById('videoScrubber');
            const prevFrameBtn = document.getElementById('prevFrameBtn');
            const nextFrameBtn = document.getElementById('nextFrameBtn');

            let currentVideoFile = null; // Holds the selected File object
            let generatedThumbnailDataUrl = ''; // Stores the base64 Data URL of the thumbnail
            let currentObjectUrl = null; // Keeps track of the blob URL for cleanup
            let isSeeking = false; // Flag to prevent infinite loops from seeked event

            // --- HELPER: Extracts Rabbi Name from Page's H1 ---
            function getRabbiNameFromPage() {
                const pageH1 = document.querySelector('.rabbi-hero h1');
                if (!pageH1) return "unknown";
                const pageH1Text = pageH1.textContent;
                if (pageH1Text.includes("Hartman")) return "rabbi_hartman";
                if (pageH1Text.includes("Rosenfeld")) return "rabbi_rosenfeld";
                if (pageH1Text.includes("Golker")) return "rabbi_golker";
                return "unknown"; 
            }

            // --- FUNCTION: Loads Shiurim from API and Populates Grid ---
            async function loadShiurim() {
                const rabbiName = getRabbiNameFromPage();
                shiurimGrid.innerHTML = '<p class="loading-message">Loading shiurim...</p>';

                try {
                    const response = await fetch(`${workerURL}/api/shiurim/${rabbiName}`);
                    if (!response.ok) throw new Error(`API returned ${response.status}: Failed to load shiurim metadata.`);
                    const shiurim = await response.json();
                    shiurimGrid.innerHTML = '';

                    const addBtnHTML = `<a href="#" class="add-shiur-card" id="addShiurBtn">+</a>`;
                    shiurimGrid.insertAdjacentHTML('beforeend', addBtnHTML);
                    // This listener now triggers the password modal
                    document.getElementById('addShiurBtn').addEventListener('click', (e) => {
                        e.preventDefault();
                        showPasswordModal();
                    });

                    if (shiurim.length === 0) {
                        shiurimGrid.insertAdjacentHTML('beforeend', `<p>No shiurim uploaded yet for this Rabbi. Be the first!</p>`);
                    } else {
                        shiurim.sort((a, b) => new Date(b.date) - new Date(a.date));
                        for (const shiur of shiurim) {
                            const displayDate = shiur.date ? new Date(shiur.date).toLocaleDateString() : 'No Date';
                            const rabbiDisplayName = shiur.rabbi ? shiur.rabbi.replace('rabbi_', 'Rabbi ').replace('_', ' ') : 'Unknown Rabbi';
                            const shiurCardHTML = `
                                <a href="../view_shiur.html?id=${shiur.id}" class="shiur-card" data-shiur-id="${shiur.id}">
                                    <div class="shiur-card-image" style="background-image: url(${shiur.thumbnailUrl || '/images/placeholder-shiur.png'});">
                                        <div class="thumbnail-view-badge" data-shiur-id="${shiur.id}">— views</div>
                                    </div>
                                    <h4>${shiur.title}</h4>
                                    <p>${rabbiDisplayName} | ${displayDate}</p>
                                </a>
                            `;
                            shiurimGrid.insertAdjacentHTML('beforeend', shiurCardHTML);
                            (async () => {
                                try {
                                    const res = await fetch(`https://beis-anytime-view-counter.beisanytime.workers.dev/api/views/${shiur.id}`, { cache: 'no-store', method: 'GET' });
                                    if (!res.ok) return;
                                    const d = await res.json();
                                    const el = document.querySelector(`.thumbnail-view-badge[data-shiur-id="${shiur.id}"]`);
                                    if (el && d && typeof d.views === 'number') el.textContent = d.views + ' views';
                                } catch (e) { /* ignore */ }
                            })();
                        }
                    }
                } catch (error) {
                    console.error("Error loading shiurim:", error);
                    shiurimGrid.innerHTML = '';
                    shiurimGrid.insertAdjacentHTML('beforeend', `<p style="color: red;">Could not load shiurim. Please try again later. (Error: ${error.message})</p>`);
                }
            }
            
            // --- PASSWORD MODAL LOGIC ---
            function showPasswordModal() {
                passwordModalOverlay.classList.remove('hidden');
                passwordInput.focus();
            }

            function hidePasswordModal() {
                passwordModalOverlay.classList.add('hidden');
                passwordInput.value = ''; // Clear password on close
                passwordError.style.display = 'none'; // Hide error message
            }

            function checkPassword() {
                const correctPassword = 'beis24/7';
                if (passwordInput.value === correctPassword) {
                    hidePasswordModal();
                    showUploadForm(); // Proceed to upload form
                } else {
                    passwordError.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }

            // --- UI TOGGLE FUNCTIONS ---
            function showUploadForm(e) {
                if(e) e.preventDefault();
                shiurimSection.style.display = 'none';
                uploadSection.style.display = 'block';
                // Reset form fields
                titleInput.value = ''; descriptionInput.value = ''; notesInput.value = '';
                fileInput.value = ''; fileNameDisplay.textContent = '';
                thumbnailPreview.style.display = 'none'; thumbnailPreview.src = '';
                dropZoneText.style.display = 'block';
                thumbnailScrubberControls.style.display = 'none';
                generatedThumbnailDataUrl = '';
                currentVideoFile = null;
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
                videoProcessor.removeAttribute('src');
                videoProcessor.load();
            }

            function hideUploadForm() {
                uploadSection.style.display = 'none';
                shiurimSection.style.display = 'block';
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
                videoProcessor.removeAttribute('src');
                videoProcessor.load();
                loadShiurim();
            }
            cancelBtn.addEventListener('click', hideUploadForm);

            // --- FORM DEFAULTS & LOCAL STORAGE ---
            dateInput.value = new Date().toISOString().split('T')[0]; 
            const savedName = localStorage.getItem('beisAnytimeUploaderName');
            if (savedName) uploaderNameInput.value = savedName;
            uploaderNameInput.addEventListener('input', () => {
                localStorage.setItem('beisAnytimeUploaderName', uploaderNameInput.value);
            });
            
            // --- THUMBNAIL GENERATION & SCRUBBER LOGIC ---
            function captureFrameAndDisplay(time) {
                if (!currentVideoFile || !currentVideoFile.type.startsWith('video/') || videoProcessor.readyState < 1) return;
                if (typeof time === 'number') {
                    videoProcessor.currentTime = Math.max(0, Math.min(time, videoProcessor.duration));
                    return; 
                }
                if (videoProcessor.currentTime < 0 || videoProcessor.currentTime >= videoProcessor.duration) {
                    videoProcessor.currentTime = 0;
                }
                if (videoProcessor.readyState < 2) {
                    videoProcessor.addEventListener('canplay', () => captureFrameAndDisplay(videoProcessor.currentTime), { once: true });
                    return;
                }
                const ctx = canvasProcessor.getContext('2d');
                canvasProcessor.width = videoProcessor.videoWidth;
                canvasProcessor.height = videoProcessor.videoHeight;
                ctx.drawImage(videoProcessor, 0, 0, canvasProcessor.width, canvasProcessor.height);
                generatedThumbnailDataUrl = canvasProcessor.toDataURL('image/jpeg', 0.8);
                thumbnailPreview.src = generatedThumbnailDataUrl;
                thumbnailPreview.style.display = 'block';
                dropZoneText.style.display = 'none';
                if (videoProcessor.duration) {
                    videoScrubber.value = (videoProcessor.currentTime / videoProcessor.duration) * 100;
                }
            }
            videoProcessor.addEventListener('seeked', () => { if (isSeeking) captureFrameAndDisplay(); });
            videoProcessor.addEventListener('loadedmetadata', () => {
                videoScrubber.min = 0; videoScrubber.max = 100; videoScrubber.value = 50;
                captureFrameAndDisplay(videoProcessor.duration / 2); 
                thumbnailScrubberControls.style.display = 'flex';
            });
            videoScrubber.addEventListener('input', () => {
                if (currentVideoFile && videoProcessor.duration) {
                    const seekTime = (parseFloat(videoScrubber.value) / 100) * videoProcessor.duration;
                    isSeeking = true;
                    videoProcessor.currentTime = seekTime;
                }
            });
            prevFrameBtn.addEventListener('click', () => {
                if (currentVideoFile && videoProcessor.duration) { isSeeking = true; videoProcessor.currentTime = Math.max(0, videoProcessor.currentTime - (1 / 30)); }
            });
            nextFrameBtn.addEventListener('click', () => {
                if (currentVideoFile && videoProcessor.duration) { isSeeking = true; videoProcessor.currentTime = Math.min(videoProcessor.duration, videoProcessor.currentTime + (1 / 30)); }
            });
            function handleFileSelect(file) {
                if (!file) return;
                currentVideoFile = file;
                fileNameDisplay.textContent = `File: ${file.name}`;
                thumbnailPreview.style.display = 'none';
                thumbnailScrubberControls.style.display = 'none';
                if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                if (file.type.startsWith('video/')) {
                    currentObjectUrl = URL.createObjectURL(file);
                    videoProcessor.src = currentObjectUrl;
                    videoProcessor.load();
                    isSeeking = false; 
                } else {
                    thumbnailPreview.src = '/images/placeholder-shiur.png';
                    thumbnailPreview.style.display = 'block';
                    dropZoneText.style.display = 'none';
                    generatedThumbnailDataUrl = '';
                    currentVideoFile = null;
                }
            }

            // --- FILE DROP ZONE LOGIC ---
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFileSelect(fileInput.files[0]); });
            
            // --- UPLOAD LOGIC ---
            uploadBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!titleInput.value || !file) { alert('Please provide a title and select a file.'); return; }
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Preparing...';
                try {
                    const metadata = {
                        title: titleInput.value, description: descriptionInput.value, notes: notesInput.value,
                        date: dateInput.value, uploaderName: uploaderNameInput.value, rabbi: getRabbiNameFromPage(),
                        fileName: file.name, fileType: file.type, thumbnailDataUrl: generatedThumbnailDataUrl
                    };
                    const apiResponse = await fetch(`${workerURL}/api/prepare-upload`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(metadata)
                    });
                    if (!apiResponse.ok) { const errorText = await apiResponse.text(); throw new Error(`API returned ${apiResponse.status}: ${errorText}`); }
                    const { signedUrl } = await apiResponse.json();
                    uploadBtn.textContent = 'Uploading file...';
                    const uploadResponse = await fetch(signedUrl, {
                        method: 'PUT', body: file, headers: { 'Content-Type': file.type }
                    });
                    if (!uploadResponse.ok) { const r2ErrorText = await uploadResponse.text(); console.error("R2 Upload Raw Error:", r2ErrorText); throw new Error(`File upload to R2 failed with status ${uploadResponse.status}.`); }
                    uploadBtn.textContent = 'Success!';
                    uploadBtn.classList.add('success');
                    setTimeout(hideUploadForm, 1500);
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert(`Upload failed. Please check the console for details. Error: ${error.message}`);
                    uploadBtn.textContent = 'Upload Failed';
                } finally {
                     setTimeout(() => {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload Shiur';
                        uploadBtn.classList.remove('success');
                    }, 2000);
                }
            });
            // --- REMEMBER PASSWORD ENTRY ---
            function hasEnteredPasswordBefore() {
                return localStorage.getItem('beisAnytimePasswordEntered') === 'true';
            }
            function markPasswordEntered() {
                localStorage.setItem('beisAnytimePasswordEntered', 'true');
            }

            // Override showPasswordModal to skip if already entered
            function showPasswordModal() {
                if (hasEnteredPasswordBefore()) {
                    showUploadForm();
                } else {
                    passwordModalOverlay.classList.remove('hidden');
                    passwordInput.focus();
                }
            }

            // Update checkPassword to mark entry
            function checkPassword() {
                const correctPassword = 'beis24/7';
                if (passwordInput.value === correctPassword) {
                    markPasswordEntered();
                    hidePasswordModal();
                    showUploadForm();
                } else {
                    passwordError.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
            // --- MODAL EVENT LISTENERS ---
            passwordModalOverlay.addEventListener('click', (e) => {
                if (e.target === passwordModalOverlay) hidePasswordModal();
            });
            passwordSubmitBtn.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') checkPassword();
            });

            // --- INITIALIZATION ---
            loadShiurim();
        });

          // --- UI Interactivity Script ---
        document.addEventListener('DOMContentLoaded', () => {
            const dropdown = document.getElementById('headerDropdown');
            const dropdownToggle = document.getElementById('dropdownToggleBtn');
            const dropdownMenu = dropdown ? dropdown.querySelector('.dropdown-menu') : null;
            const donateBtn = document.getElementById('donateBtn');
            const notificationBell = document.getElementById('notificationBell');
            const notificationModal = document.getElementById('notificationModal');
            const closeNotificationModal = document.getElementById('closeNotificationModal');
            const enableNotifications = document.getElementById('enableNotifications');
            const notificationStatus = document.getElementById('notificationStatus');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const userInfo = document.querySelector('.user-info');

            if (dropdown && dropdownToggle) {
                dropdownToggle.addEventListener('click', (event) => {
                    event.stopPropagation();
                    dropdown.classList.toggle('is-active');
                });
                
                window.addEventListener('click', (event) => {
                    if (dropdown.classList.contains('is-active') && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('is-active');
                    }
                });
            }

            // Donate button handler (example: open external link)
            if (donateBtn) {
                donateBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.open('https://your-donation-link.com', '_blank');
                    console.log('Donate button clicked');
                });
            }

            // Notification modal logic
            if (notificationBell && notificationModal && closeNotificationModal) {
                notificationBell.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationModal.style.display = 'block';
                    console.log('Notifications button clicked');
                });
                closeNotificationModal.addEventListener('click', () => {
                    notificationModal.style.display = 'none';
                });
                window.addEventListener('click', (event) => {
                    if (event.target === notificationModal) {
                        notificationModal.style.display = 'none';
                    }
                });
            }
            // Google login fallback
            if (googleLoginBtn) {
                setTimeout(() => {
                    if (!googleLoginBtn.hasChildNodes()) {
                        googleLoginBtn.innerHTML = '<span style="color:red;">Google login failed to load.</span>';
                        if (userInfo) userInfo.style.display = 'none';
                    }
                }, 3000);
            }

            // Notification permission logic
            if (enableNotifications && notificationStatus) {
                enableNotifications.checked = localStorage.getItem('notificationsEnabled') === 'true';
                enableNotifications.addEventListener('change', async function() {
                    if (this.checked) {
                        if (Notification.permission === 'granted') {
                            localStorage.setItem('notificationsEnabled', 'true');
                            notificationStatus.textContent = 'Notifications enabled!';
                        } else if (Notification.permission !== 'denied') {
                            let perm = await Notification.requestPermission();
                            if (perm === 'granted') {
                                localStorage.setItem('notificationsEnabled', 'true');
                                notificationStatus.textContent = 'Notifications enabled!';
                            } else {
                                this.checked = false;
                                notificationStatus.textContent = 'Notifications blocked.';
                            }
                        } else {
                            this.checked = false;
                            notificationStatus.textContent = 'Notifications blocked.';
                        }
                    } else {
                        localStorage.setItem('notificationsEnabled', 'false');
                        notificationStatus.textContent = 'Notifications disabled.';
                    }
                });
            }
        });
    </script>
    <script src="quiz.js"></script>
</body></html>