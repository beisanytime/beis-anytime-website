<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiurim from Rabbi Hartman - Beis Anytime</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Password Modal -->
    <div id="passwordModal">
        <div class="modal-content">
            <h2>Enter Password to Upload</h2>
            <input type="password" id="passwordInput" placeholder="Password">
            <button id="passwordSubmit">Submit</button>
        </div>
    </div>

    <header class="site-header">
        <div class="container header-container">
            <div class="logo">
                <a href="index.html">Beis Anytime</a>
            </div>
            <div class="nav-wrapper">
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="#">All Shiurim</a></li>
                    </ul>
                </nav>
                <div class="dark-mode-toggle" id="theme-toggle">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- CHANGE THIS BACKGROUND IMAGE FOR EACH RABBI -->
        <section class="rabbi-hero" style="background-image: url('images/rabbi_hartman.png');">
            <div class="rabbi-hero-content">
                <!-- CHANGE THIS H1 FOR EACH RABBI -->
                <h1>Shiurim from Rabbi Hartman</h1>
            </div>
        </section>

        <!-- Section 1: Shiurim Grid (Visible by default) -->
        <section class="shiurim-section" id="shiurimSection">
            <div class="container">
                <div class="shiur-grid">
                    <!-- The '+' card now an 'a' tag without href to act as a button -->
                    <a class="add-shiur-card" id="addShiurBtn">+</a>

                    <!-- Fill in the appropriate template shiurim for each rabbi -->
                    <div class="shiur-card"><h4>Parashas Ki Savo</h4><p>Sept 18, 2025</p></div>
                    <div class="shiur-card"><h4>The Essence of Rosh Hashana</h4><p>Sept 17, 2025</p></div>
                    <div class="shiur-card"><h4>Hilchos Tzedakah</h4><p>Sept 16, 2025</p></div>
                </div>
            </div>
        </section>

        <!-- Section 2: Upload Form (Hidden by default) -->
        <section class="upload-section" id="uploadSection">
            <div class="container">
                 <div class="upload-container">
                    <h1>Upload a Shiur</h1>
                    <div class="upload-left">
                        <div class="file-drop-zone" id="dropZone">
                            <span class="file-drop-zone-icon">â–²</span>
                            <p>Drag & drop file here</p>
                            <span>or click to browse</span>
                            <p id="fileName"></p>
                        </div>
                        <input type="file" id="fileInput" style="display: none;">
                    </div>
                    <div class="upload-right">
                        <div class="input-group">
                            <label for="title">Title</label>
                            <input type="text" id="title" placeholder="e.g., Parashas Ki Savo" required>
                        </div>
                        <div class="input-group">
                            <label for="description">Description (Optional)</label>
                            <textarea id="description" placeholder="A brief summary..."></textarea>
                        </div>
                    </div>
                    <div class="upload-bottom">
                         <div class="input-group">
                            <label for="notes">Notes (Optional)</label>
                            <textarea id="notes" placeholder="Paste in notes or sources..."></textarea>
                        </div>
                    </div>
                    <div class="upload-meta">
                        <div class="input-group">
                            <label for="date">Date</label>
                            <input type="date" id="date">
                        </div>
                        <div class="input-group">
                            <label for="uploaderName">Uploaded By</label>
                            <input type="text" id="uploaderName" placeholder="Your Name">
                        </div>
                    </div>
                    <div class="upload-actions">
                        <button class="cancel-button" id="cancelBtn">Cancel</button>
                        <button class="upload-button" id="uploadBtn">Upload Shiur</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="site-footer">
        <div class="container footer-container">
            <p>&copy; 2025 Beis Anytime</p>
            <p>Designed with Purpose</p>
        </div>
    </footer>

    <!-- Hidden elements for video thumbnail processing (off-screen) -->
    <video id="video-processor" muted preload="metadata" style="display: none;"></video>
    <canvas id="canvas-processor" style="display: none;"></canvas>

    <script>
        // --- DARK MODE LOGIC ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const currentTheme = localStorage.getItem('theme');

        if (currentTheme) {
            document.body.classList.add(currentTheme);
            if (currentTheme === 'dark-mode') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            let theme = 'light-mode';
            if (document.body.classList.contains('dark-mode')) {
                theme = 'dark-mode';
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            localStorage.setItem('theme', theme);
        });

        // --- UPLOAD FORM LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Section Elements ---
            const shiurimSection = document.getElementById('shiurimSection');
            const uploadSection = document.getElementById('uploadSection');
            
            // --- Button Elements ---
            const addShiurBtn = document.getElementById('addShiurBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const uploadBtn = document.getElementById('uploadBtn');

            // --- Form Input Elements ---
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const dateInput = document.getElementById('date');
            const uploaderNameInput = document.getElementById('uploaderName');
            const dropZone = document.getElementById('dropZone');
            const fileNameDisplay = document.getElementById('fileName');
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const notesInput = document.getElementById('notes');
            
            // Password Modal Elements
            const passwordModal = document.getElementById('passwordModal');
            const passwordInput = document.getElementById('passwordInput');
            const passwordSubmit = document.getElementById('passwordSubmit');

            // --- Hide password modal when clicking outside modal-content ---
            passwordModal.addEventListener('click', (e) => {
                if (e.target === passwordModal) {
                    passwordModal.style.display = 'none';
                }
            });

            // Elements for thumbnail generation
            const videoProcessor = document.getElementById('video-processor');
            const canvasProcessor = document.getElementById('canvas-processor');
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            const dropZoneText = document.getElementById('dropZoneText');

            // Thumbnail scrubber controls
            const thumbnailScrubberControls = document.getElementById('thumbnailScrubberControls');
            const videoScrubber = document.getElementById('videoScrubber');
            const prevFrameBtn = document.getElementById('prevFrameBtn');
            const nextFrameBtn = document.getElementById('nextFrameBtn');

            let currentVideoFile = null; // Holds the selected File object
            let generatedThumbnailDataUrl = ''; // Stores the base64 Data URL of the thumbnail
            let currentObjectUrl = null; // Keeps track of the blob URL for cleanup
            let isSeeking = false; // Flag to prevent infinite loops from seeked event
            
            // --- PASSWORD AUTHENTICATION ---
            function checkPassword() {
                if (localStorage.getItem(AUTH_KEY) === 'true') {
                    return true;
                }
                passwordModal.style.display = 'flex';
                return false;
            }

            passwordSubmit.addEventListener('click', () => {
                if (passwordInput.value === UPLOAD_PASSWORD) {
                    localStorage.setItem(AUTH_KEY, 'true');
                    passwordModal.style.display = 'none';
                } else {
                    alert('Incorrect password.');
                }
            });


            // --- HELPER: Extracts Rabbi Name from Page's H1 ---
            function getRabbiNameFromPage() {
                const pageH1 = document.querySelector('.rabbi-hero h1');
                if (!pageH1) return "unknown"; // Handle case where H1 might not exist

                const pageH1Text = pageH1.textContent;
                if (pageH1Text.includes("Hartman")) return "rabbi_hartman";
                if (pageH1Text.includes("Rosenfeld")) return "rabbi_rosenfeld";
                if (pageH1Text.includes("Golker")) return "rabbi_golker";
                return "unknown"; 
            }

            // --- FUNCTION: Loads Shiurim from API and Populates Grid ---
            async function loadShiurim() {
                const rabbiName = getRabbiNameFromPage();
                shiurimGrid.innerHTML = '<p class="loading-message">Loading shiurim...</p>'; // Show loading

                try {
                    const response = await fetch(`${workerURL}/api/shiurim/${rabbiName}`);
                    if (!response.ok) throw new Error(`API returned ${response.status}: Failed to load shiurim metadata.`);
                    const shiurim = await response.json();

                    shiurimGrid.innerHTML = ''; // Clear loading message

                    // Always add the '+' card first
                    const addBtnHTML = `<a href="#" class="add-shiur-card" id="addShiurBtn">+</a>`;
                    shiurimGrid.insertAdjacentHTML('beforeend', addBtnHTML);
                    document.getElementById('addShiurBtn').addEventListener('click', showUploadForm);

                    if (shiurim.length === 0) {
                        shiurimGrid.insertAdjacentHTML('beforeend', `<p>No shiurim uploaded yet for this Rabbi. Be the first!</p>`);
                    } else {
                        // Sort shiurim by date, newest first
                        shiurim.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        for (const shiur of shiurim) {
                            const displayDate = shiur.date ? new Date(shiur.date).toLocaleDateString() : 'No Date';
                            const rabbiDisplayName = shiur.rabbi ? shiur.rabbi.replace('rabbi_', 'Rabbi ') : 'Unknown Rabbi';

                            const shiurCardHTML = `
                                <a href="view_shiur.html?id=${shiur.id}" class="shiur-card">
                                    <div class="shiur-card-image" style="background-image: url(${shiur.thumbnailUrl || '/images/placeholder-shiur.png'});"></div>
                                    <h4>${shiur.title}</h4>
                                    <p>${rabbiDisplayName} | ${displayDate}</p>
                                </a>
                            `;
                            shiurimGrid.insertAdjacentHTML('beforeend', shiurCardHTML);
                        }
                    }
                } catch (error) {
                    console.error("Error loading shiurim:", error);
                    shiurimGrid.innerHTML = '';
                    shiurimGrid.insertAdjacentHTML('beforeend', `<p style="color: red;">Could not load shiurim. Please try again later. (Error: ${error.message})</p>`);
                }
            }
            
            // --- UI Toggle Functions ---
            function showUploadForm(e) {
                if(e) e.preventDefault(); // Prevent default link behavior
                
                // Check for password before showing the form
                if (!checkPassword()) {
                    return; 
                }

                shiurimSection.style.display = 'none';
                uploadSection.style.display = 'block';
                // Reset form fields and states
                titleInput.value = ''; descriptionInput.value = ''; notesInput.value = '';
                fileInput.value = ''; fileNameDisplay.textContent = '';
                thumbnailPreview.style.display = 'none'; thumbnailPreview.src = '';
                dropZoneText.style.display = 'block';
                thumbnailScrubberControls.style.display = 'none';
                generatedThumbnailDataUrl = '';
                currentVideoFile = null;

                // Clean up any lingering blob URLs from previous video selections when showing the form
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
                videoProcessor.removeAttribute('src'); // Remove src to ensure clean state
                videoProcessor.load(); // Load the empty video state
            }

            function hideUploadForm() {
                uploadSection.style.display = 'none';
                shiurimSection.style.display = 'block';
            });

            // --- Set Default Date ---
            const today = new Date();
            dateInput.value = today.toISOString().split('T')[0];

            // --- FORM DEFAULTS & LOCAL STORAGE ---
            dateInput.value = new Date().toISOString().split('T')[0]; 
            const savedName = localStorage.getItem('beisAnytimeUploaderName');
            if (savedName) uploaderNameInput.value = savedName;
            uploaderNameInput.addEventListener('input', () => {
                localStorage.setItem('beisAnytimeUploaderName', uploaderNameInput.value);
            });
            
            // --- THUMBNAIL GENERATION & SCRUBBER LOGIC ---

            /**
             * Captures the current frame of the video and displays it as a thumbnail.
             * Also updates the scrubber position.
             * @param {number} [time] - Optional time in seconds to seek to before capturing.
             */
            function captureFrameAndDisplay(time) {
                // Ensure we have a video file loaded and the processor is ready
                if (!currentVideoFile || !currentVideoFile.type.startsWith('video/') || videoProcessor.readyState < 1) { // 1 = HAVE_METADATA
                    return;
                }

                // If a specific time is provided, attempt to seek
                if (typeof time === 'number') {
                    videoProcessor.currentTime = Math.max(0, Math.min(time, videoProcessor.duration));
                    // Do not draw immediately, wait for 'seeked' event
                    return; 
                }
                
                // If no time was specified, but we are already on a frame (e.g., from seeked event)
                // Ensure it's within bounds and video data is available
                if (videoProcessor.currentTime < 0 || videoProcessor.currentTime >= videoProcessor.duration) {
                    videoProcessor.currentTime = 0; // Reset to start if out of bounds
                }

                if (videoProcessor.readyState < 2) { // 2 = HAVE_CURRENT_DATA
                    // Wait for enough data to be loaded to draw the frame
                    videoProcessor.addEventListener('canplay', () => {
                        captureFrameAndDisplay(videoProcessor.currentTime); // Retry after becoming playable
                    }, { once: true });
                    return;
                }

                // Draw the current frame to the canvas
                const ctx = canvasProcessor.getContext('2d');
                canvasProcessor.width = videoProcessor.videoWidth;
                canvasProcessor.height = videoProcessor.videoHeight;
                ctx.drawImage(videoProcessor, 0, 0, canvasProcessor.width, canvasProcessor.height);

                // Convert canvas to Data URL (JPEG) and update preview
                generatedThumbnailDataUrl = canvasProcessor.toDataURL('image/jpeg', 0.8);
                thumbnailPreview.src = generatedThumbnailDataUrl;
                thumbnailPreview.style.display = 'block';
                dropZoneText.style.display = 'none'; // Hide original text

                // Update the scrubber's value to match the current time
                if (videoProcessor.duration) {
                    videoScrubber.value = (videoProcessor.currentTime / videoProcessor.duration) * 100;
                }
            }

            // Event listener for when the video has seeked to a new position
            videoProcessor.addEventListener('seeked', () => {
                if (isSeeking) { // Prevent infinite loops
                    captureFrameAndDisplay(); // Capture the frame at the new currentTime
                }
            });
            
            // Event listener for when video metadata is loaded. This is crucial for duration etc.
            videoProcessor.addEventListener('loadedmetadata', () => {
                videoScrubber.min = 0;
                videoScrubber.max = 100;
                videoScrubber.value = 50; // Start scrubber in the middle
                
                // Capture the frame at the middle of the video
                captureFrameAndDisplay(videoProcessor.duration / 2); 
                thumbnailScrubberControls.style.display = 'flex'; // Show scrubber controls
            });

            // Scrubber input event: Updates video playback time and captures frame
            videoScrubber.addEventListener('input', () => {
                if (currentVideoFile && videoProcessor.duration) {
                    const seekTime = (parseFloat(videoScrubber.value) / 100) * videoProcessor.duration;
                    isSeeking = true; // Set flag before seeking
                    videoProcessor.currentTime = seekTime;
                    // The 'seeked' event will then trigger captureFrameAndDisplay
                }
            });
            
            // Previous/Next Frame buttons: Small steps for frame adjustment
            prevFrameBtn.addEventListener('click', () => {
                if (currentVideoFile && videoProcessor.duration) {
                    // Seek back by a small amount (e.g., 1/30th of a second)
                    isSeeking = true;
                    videoProcessor.currentTime = Math.max(0, videoProcessor.currentTime - (1 / 30));
                }
            });
            nextFrameBtn.addEventListener('click', () => {
                if (currentVideoFile && videoProcessor.duration) {
                    // Seek forward by a small amount
                    isSeeking = true;
                    videoProcessor.currentTime = Math.min(videoProcessor.duration, videoProcessor.currentTime + (1 / 30));
                }
            });

            // Handles file selection via click or drag-and-drop
            function handleFileSelect(file) {
                if (!file) return;

                currentVideoFile = file;
                fileNameDisplay.textContent = `File: ${file.name}`;
                
                thumbnailPreview.style.display = 'none'; // Hide preview while processing
                thumbnailScrubberControls.style.display = 'none'; // Hide controls by default

                // Clean up any *previous* object URL before creating a new one
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }

                if (file.type.startsWith('video/')) {
                    currentObjectUrl = URL.createObjectURL(file); // Create a temporary URL for the video
                    videoProcessor.src = currentObjectUrl;
                    videoProcessor.load(); // Load the new video source
                    
                    // Reset seeking flag when a new file is loaded
                    isSeeking = false; 

                    // The 'loadedmetadata' event will now fire, which sets up the scrubber and captures the frame.
                } else {
                    // If it's an audio file or not a video, show a default placeholder
                    thumbnailPreview.src = '/images/placeholder-shiur.png';
                    thumbnailPreview.style.display = 'block';
                    dropZoneText.style.display = 'none';
                    generatedThumbnailDataUrl = ''; // Ensure no old thumbnail data is kept
                    currentVideoFile = null; // Not a video, so clear this
                }
            }

            // --- FILE DROP ZONE LOGIC ---
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', () => {
                handleFileSelect(fileInput.files[0]);
            });
            
            // --- UPLOAD LOGIC ---
            uploadBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!titleInput.value || !file) { alert('Please provide a title and select a file.'); return; }

                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Preparing...';

                try {
                    // Step 1: Send metadata (including the generated thumbnail Data URL) to the Worker
                    const metadata = {
                        title: titleInput.value,
                        description: descriptionInput.value,
                        notes: notesInput.value,
                        date: dateInput.value,
                        uploaderName: uploaderNameInput.value,
                        rabbi: getRabbiNameFromPage(),
                        fileName: file.name,
                        fileType: file.type,
                        thumbnailDataUrl: generatedThumbnailDataUrl // The generated thumbnail data
                    };
                    
                    const apiResponse = await fetch(`${workerURL}/api/prepare-upload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(metadata)
                    });

                    if (!apiResponse.ok) {
                        const errorText = await apiResponse.text();
                        throw new Error(`API returned ${apiResponse.status}: ${errorText}`);
                    }
                    const { signedUrl } = await apiResponse.json(); // Get the presigned URL for PUT
                    
                    // Step 2: Upload the actual file directly to R2 using the presigned PUT URL
                    uploadBtn.textContent = 'Uploading file...';
                    
                    const uploadResponse = await fetch(signedUrl, {
                        method: 'PUT',
                        body: file, // Send the raw file object as the request body
                        headers: {
                            'Content-Type': file.type // Crucial for R2 to correctly store the file type
                        }
                    });

                    if (!uploadResponse.ok) {
                        const r2ErrorText = await uploadResponse.text(); 
                        console.error("R2 Upload Raw Error:", r2ErrorText);
                        throw new Error(`File upload to R2 failed with status ${uploadResponse.status}. Details in console.`);
                    }

                    // Step 3: Success!
                    uploadBtn.textContent = 'Success!';
                    uploadBtn.classList.add('success');
                    
                    setTimeout(() => {
                        // Reset form
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload Shiur';
                        uploadBtn.classList.remove('success');
                        titleInput.value = '';
                        document.getElementById('description').value = '';
                        document.getElementById('notes').value = '';
                        fileInput.value = '';
                        updateFileName();
                        // Go back to the shiurim list
                        cancelBtn.click();
                    }, 1500);
                }, 1500);
            });
        });
    </script>
    <script src="quiz.js"></script>
</body>
</html>
