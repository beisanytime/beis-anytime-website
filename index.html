<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beis Anytime</title>
    
    <!-- Fonts: Inter for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Sign-In -->
    <link rel="preconnect" href="https://accounts.google.com">

<style>
/* =================================================================================
   Beis Anytime - Premium Streaming Design v11.1
   Updates: Uniform Grid Layout (All cards same size)
================================================================================= */

:root {
    /* --- Brand & Rabbi Palette (HSL) --- */
    --c-hartman: 210, 96%, 45%;    
    --c-rosenfeld: 150, 90%, 35%;  
    --c-golker: 25, 95%, 50%;      
    --c-guests: 270, 60%, 55%;     

    /* --- Functional Colors --- */
    --primary-hue: 220;
    --color-accent: hsl(var(--primary-hue), 90%, 50%);
    --focus-ring: 0 0 0 3px hsla(var(--primary-hue), 90%, 50%, 0.3);

    /* --- Light Theme Variables --- */
    --bg-body: hsl(220, 20%, 97%);
    --bg-surface: hsla(0, 0%, 100%, 0.7);
    --bg-surface-solid: hsl(0, 0%, 100%);
    --bg-surface-hover: hsla(220, 20%, 94%, 0.8);
    --bg-glass: hsla(0, 0%, 100%, 0.85); 
    
    --text-main: hsl(220, 30%, 12%);
    --text-muted: hsl(220, 10%, 45%);
    --text-faint: hsl(220, 10%, 70%);

    --border-light: hsla(220, 20%, 85%, 0.6);
    --border-hover: hsla(220, 20%, 75%, 0.8);

    --shadow-sm: 0 1px 2px rgba(0,0,0,0.03);
    --shadow-md: 0 8px 16px -4px rgba(0,0,0,0.04), 0 4px 8px -2px rgba(0,0,0,0.02);
    --shadow-lg: 0 20px 40px -8px rgba(0,0,0,0.08);
    
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 20px;

    /* --- Layout --- */
    --sidebar-w: 260px;
    --header-h: 70px;
    --container-max: 1350px;
    
    --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
}

[data-theme="dark"] {
    --bg-body: hsl(220, 25%, 8%);
    --bg-surface: hsla(220, 25%, 12%, 0.7);
    --bg-surface-solid: hsl(220, 25%, 12%);
    --bg-surface-hover: hsla(220, 25%, 16%, 0.8);
    --bg-glass: hsla(220, 25%, 10%, 0.85);

    --text-main: hsl(220, 10%, 96%);
    --text-muted: hsl(220, 10%, 65%);
    --text-faint: hsl(220, 10%, 40%);

    --border-light: hsla(220, 20%, 25%, 0.6);
    --border-hover: hsla(220, 20%, 35%, 0.8);

    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
    --shadow-md: 0 8px 24px rgba(0,0,0,0.3);
    --shadow-lg: 0 24px 48px rgba(0,0,0,0.5);
}

/* --- Base --- */
*, *::before, *::after { box-sizing: border-box; }

body {
    margin: 0;
    font-family: var(--font-ui);
    background-color: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
    background-image: 
        radial-gradient(at 0% 0%, hsla(210, 100%, 93%, 1) 0px, transparent 50%),
        radial-gradient(at 100% 0%, hsla(150, 100%, 93%, 1) 0px, transparent 50%);
    background-attachment: fixed;
    transition: background-color 0.3s;
}

[data-theme="dark"] body {
    background-image: 
        radial-gradient(at 0% 0%, hsla(210, 60%, 15%, 1) 0px, transparent 50%),
        radial-gradient(at 100% 0%, hsla(150, 60%, 15%, 1) 0px, transparent 50%);
}

body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 50;
    opacity: 0.5;
}

@view-transition { navigation: auto; }

/* --- App Shell --- */
.app-shell { display: flex; min-height: 100vh; position: relative; z-index: 1; }

/* --- Sidebar --- */
.sidebar {
    width: var(--sidebar-w);
    background-color: var(--bg-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-right: 1px solid var(--border-light);
    height: 100vh;
    position: fixed;
    top: 0; left: 0;
    z-index: 100;
    display: flex;
    flex-direction: column;
    padding-bottom: env(safe-area-inset-bottom);
}

.sidebar-header {
    height: var(--header-h);
    display: flex;
    align-items: center;
    padding: 0 24px;
    margin-bottom: 20px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: var(--text-main);
    font-weight: 800;
    font-size: 1.2rem;
    letter-spacing: -0.03em;
}

.nav-menu { flex: 1; padding: 0 16px; display: flex; flex-direction: column; gap: 6px; }

.nav-item {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    color: var(--text-muted); text-decoration: none; border-radius: var(--radius-sm);
    font-size: 0.95rem; font-weight: 500; transition: all 0.2s ease;
}

.nav-item:hover { background-color: var(--bg-surface-hover); color: var(--text-main); }
.nav-item.active { background-color: var(--bg-surface-solid); color: var(--color-accent); font-weight: 600; box-shadow: var(--shadow-sm); }
.nav-item i { width: 20px; text-align: center; }

.sidebar-footer { padding: 24px 16px; border-top: 1px solid var(--border-light); }

/* --- Main Content --- */
.main-viewport {
    flex: 1;
    margin-left: var(--sidebar-w);
    width: calc(100% - var(--sidebar-w));
    padding: 40px 60px;
    transition: background-color 0.5s ease;
}

.page-container {
    max-width: var(--container-max);
    margin: 0 auto;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- Global Menu --- */
.popup-menu {
    position: fixed; 
    background: var(--bg-surface-solid);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    padding: 8px;
    z-index: 2000;
    display: none;
    bottom: 80px; 
    left: 20px; 
    width: 240px;
}

.popup-menu.active { display: block; animation: slideUp 0.2s cubic-bezier(0.2, 0, 0, 1); }
.menu-header { padding: 12px; border-bottom: 1px solid var(--border-light); margin-bottom: 8px; }

@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- Mobile Nav --- */
.bottom-nav { display: none; }

/* --- Feed & Comments Styles --- */
.feed-container { max-width: 700px; margin: 0 auto; }

.post-composer, .comment-composer {
    background: var(--bg-surface-solid);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-sm);
}

.post-card, .comment-item {
    background: var(--bg-surface-solid);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s, box-shadow 0.2s;
    animation: fadeIn 0.4s ease;
}
.post-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.post-header, .comment-header { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 12px; }
.post-avatar, .comment-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; }
.post-meta, .comment-meta { display: flex; flex-direction: column; }
.post-author, .comment-author { font-weight: 700; color: var(--text-main); font-size: 0.95rem; }
.post-time, .comment-time { font-size: 0.8rem; color: var(--text-muted); }

.post-content, .comment-text { color: var(--text-main); line-height: 1.6; font-size: 1rem; white-space: pre-wrap; }
.post-actions { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 12px; }

/* --- Components --- */
.hero-card {
    background: linear-gradient(135deg, var(--bg-surface-solid), var(--bg-surface-hover));
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 48px;
    margin-bottom: 40px;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-md);
}

.hero-card::before {
    content: ''; position: absolute; top: -50px; right: -50px; width: 400px; height: 400px;
    background: radial-gradient(circle, hsla(var(--primary-hue), 80%, 50%, 0.1) 0%, transparent 70%);
    pointer-events: none;
}

.hero-actions { margin-top: 24px; display: flex; gap: 12px; }

/* --- Grid (Uniform Size) --- */
.grid-videos {
    display: grid;
    /* Ensure a consistent minimum width for all cards */
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
}

@media (min-width: 1200px) {
    /* Enforce 3 columns on large screens, but NO special spanning logic */
    .grid-videos { grid-template-columns: repeat(3, 1fr); }
}

.video-card {
    background: var(--bg-surface-solid);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    text-decoration: none;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex; flex-direction: column; position: relative;
    view-transition-name: card-generic; 
}
.video-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); z-index: 2; }

.thumb-wrapper { position: relative; aspect-ratio: 16 / 9; background: var(--bg-surface-hover); overflow: hidden; }
.thumb-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
.video-card:hover .thumb-img { transform: scale(1.05); }

.rabbi-badge {
    position: absolute; bottom: 12px; left: 12px; padding: 6px 12px; border-radius: 99px;
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
    backdrop-filter: blur(8px); background: rgba(15, 23, 42, 0.8); color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px;
}
.rabbi-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
[data-rabbi="Rabbi_Hartman"] .rabbi-dot { background: hsl(var(--c-hartman)); }
[data-rabbi="Rabbi_Rosenfeld"] .rabbi-dot { background: hsl(var(--c-rosenfeld)); }
[data-rabbi="Rabbi_Golker"] .rabbi-dot { background: hsl(var(--c-golker)); }
[data-rabbi="guests"] .rabbi-dot { background: hsl(var(--c-guests)); }

.card-content { padding: 20px; flex: 1; display: flex; flex-direction: column; }
.card-title {
    font-size: 1rem; font-weight: 600; color: var(--text-main); margin: 0 0 8px 0;
    line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.card-date { margin-top: auto; font-size: 0.8rem; color: var(--text-muted); }

.btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 24px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9rem;
    cursor: pointer; transition: all 0.2s; border: 1px solid transparent; text-decoration: none;
}
.btn-primary { background-color: var(--text-main); color: var(--bg-body); }
.btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); opacity: 0.95; }
.btn-secondary { background-color: var(--bg-surface-solid); border-color: var(--border-light); color: var(--text-main); }
.btn-secondary:hover { border-color: var(--text-muted); background: var(--bg-surface-hover); }

input, select, textarea {
    width: 100%; padding: 12px; background: var(--bg-surface-solid); border: 1px solid var(--border-light);
    border-radius: var(--radius-sm); color: var(--text-main); font-family: inherit; font-size: 0.95rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, textarea:focus { outline: none; border-color: var(--color-accent); box-shadow: var(--focus-ring); }

/* --- Mobile Responsiveness --- */
@media (max-width: 1024px) {
    .sidebar { display: none; }
    
    .main-viewport { margin-left: 0; width: 100%; padding: 24px 20px 100px 20px; }

    .bottom-nav {
        display: flex; justify-content: space-around; align-items: center;
        position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
        background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid var(--border-light); z-index: 999;
        padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }

    .bottom-nav-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-decoration: none; color: var(--text-muted); font-size: 0.7rem; gap: 6px;
        width: 100%; height: 100%; font-weight: 500;
    }

    .bottom-nav-item i { font-size: 1.25rem; transition: transform 0.2s; }
    .bottom-nav-item.active { color: var(--color-accent); }
    .bottom-nav-item.active i { transform: translateY(-2px); }

    .grid-videos { grid-template-columns: 1fr; }
    /* Mobile resets are automatic due to removing :first-child specific css */

    .popup-menu {
        left: 16px; right: 16px; bottom: 80px; width: auto; transform: translateY(20px);
    }
}

/* --- Cinema Mode --- */
body[data-page-context="view_shiur"] .main-viewport { background-image: none; background-color: #050505; }
body[data-page-context="view_shiur"] .video-card { display: none; }
body[data-page-context="view_shiur"] h1,
body[data-page-context="view_shiur"] h2,
body[data-page-context="view_shiur"] p:not(.comment-text),
body[data-page-context="view_shiur"] .btn-ghost { color: #e5e5e5; }

.video-container {
    background: #000; border-radius: var(--radius-md); overflow: hidden;
    box-shadow: 0 0 80px -20px hsla(var(--primary-hue), 50%, 40%, 0.3);
    aspect-ratio: 16/9; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);
}

.video-details, .video-comments-area {
    background: var(--bg-surface-solid); border: 1px solid var(--border-light);
    border-radius: var(--radius-md); padding: 24px; margin-bottom: 20px;
}
.video-comments-area {
    /* Revert color for comments area to normal theme even in cinema mode */
    background: var(--bg-surface-solid);
    color: var(--text-main);
}
body[data-page-context="view_shiur"] .video-comments-area h2,
body[data-page-context="view_shiur"] .video-comments-area p { color: var(--text-main); }
body[data-page-context="view_shiur"] .video-comments-area .comment-time { color: var(--text-muted); }

/* --- Profile --- */
.profile-wrapper { position: relative; }
.profile-trigger {
    background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px;
    padding: 6px; border-radius: 99px; transition: background 0.2s;
}
.profile-trigger:hover { background: var(--bg-surface-hover); }
.avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-body); }

/* --- Utilities --- */
.skeleton {
    background: linear-gradient(90deg, var(--bg-surface-hover) 25%, var(--border-light) 50%, var(--bg-surface-hover) 75%);
    background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-sm);
}
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.hidden { display: none !important; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.empty-state { text-align: center; padding: 60px 20px; grid-column: 1 / -1; }
.empty-icon { font-size: 3rem; color: var(--border-light); margin-bottom: 16px; }

</style>
</head>
<body>

    <div class="app-shell">
        
        <!-- Sidebar (Desktop) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo nav-link" onclick="loadPage('home'); return false;">
                    <i class="fas fa-play-circle" style="color: var(--color-accent)"></i>
                    <span>BEIS ANYTIME</span>
                </a>
            </div>

            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="#" class="nav-item" data-page="all">
                    <i class="fas fa-compass"></i> Browse
                </a>
                <a href="#" class="nav-item" data-page="community">
                    <i class="fas fa-users"></i> Community
                </a>
                <a href="#" class="nav-item" data-page="speakers">
                    <i class="fas fa-microphone-lines"></i> Speakers
                </a>
            </nav>

            <div style="flex:1;"></div>

            <div class="sidebar-footer">
                <div class="flex-between">
                    <button class="btn btn-secondary" style="padding: 8px; border-radius:50%; width:36px; height:36px;" id="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>

                    <!-- Auth: Desktop Sidebar -->
                    <div id="desktop-auth-container">
                        <div id="g_id_onload" 
                             data-client_id="248585696121-67ecvsoqhtbpc0b2qt5f486864p0uvnq.apps.googleusercontent.com" 
                             data-callback="handleCredentialResponse">
                        </div>
                        <div class="g_id_signin" data-type="icon" data-shape="circle" data-theme="outline"></div>
                    </div>

                    <!-- Profile Trigger (Desktop) -->
                    <div class="profile-wrapper" id="profileDropdown" style="display: none;">
                        <button class="profile-trigger" id="profileToggle">
                            <img id="userAvatar" src="" class="avatar" alt="User">
                            <i class="fas fa-chevron-up" style="font-size: 0.8rem; color: var(--text-muted)"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-viewport">
            <div id="app-content" class="page-container">
                <!-- Content injected here -->
                <div style="display: grid; gap: 20px;">
                    <div class="skeleton" style="height: 300px; border-radius: 20px;"></div>
                    <div class="skeleton" style="height: 40px; width: 60%;"></div>
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="bottom-nav-item active" data-page="home">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="#" class="bottom-nav-item" data-page="all">
                <i class="fas fa-compass"></i> Browse
            </a>
            <a href="#" class="bottom-nav-item" data-page="community">
                <i class="fas fa-users"></i> Feed
            </a>
            <a href="#" class="bottom-nav-item" id="mobileProfileBtn">
                <i class="fas fa-user"></i> Profile
            </a>
        </nav>

    </div>

    <!-- GLOBAL DROPDOWN MENU -->
    <div class="popup-menu" id="globalMenu">
        
        <!-- Logged In State -->
        <div id="menuLoggedIn" style="display:none;">
            <div class="menu-header">
                <div id="menuUserName" style="font-weight: 600; font-size: 0.95rem;"></div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Member</div>
            </div>
            
            <a href="#" class="nav-item" id="adminLink" style="display: none;" onclick="loadPage('admin'); return false;">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </a>

            <!-- UPLOAD LINK -->
            <a href="#" class="nav-item" id="uploadLink" style="display: none;" onclick="loadPage('upload'); return false;">
                <i class="fas fa-upload"></i> Upload Shiur
            </a>

            <a href="#" class="nav-item" id="signOutBtn" style="color: var(--c-golker);">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </a>
        </div>

        <!-- Logged Out State -->
        <div id="menuLoggedOut" style="text-align:center; padding: 12px;">
            <p style="font-size: 0.9rem; margin-bottom: 12px; color: var(--text-muted);">Sign in to access features.</p>
            <button class="btn btn-primary" style="width:100%" onclick="google.accounts.id.prompt()">
                Sign In with Google
            </button>
        </div>
    </div>

    <video id="video-processor" muted preload="none" style="display: none;"></video>
    <canvas id="canvas-processor" style="display: none;"></canvas>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// =================================================================================
// Beis Anytime - Application Logic
// =================================================================================

// --- Lazy Loading ---
const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
            }
        }
    });
}, { rootMargin: '200px' });

// --- Google Auth ---
window.handleCredentialResponse = (response) => {
    try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const currentUser = { name: payload.name, email: payload.email, picture: payload.picture };
        localStorage.setItem('googleUser', JSON.stringify(currentUser));
        window.dispatchEvent(new CustomEvent('google-signin-success', { detail: currentUser }));
    } catch (e) { console.error(e); }
};

document.addEventListener('DOMContentLoaded', () => {
    // --- Configuration ---
    const MAIN_API_URL = 'https://beis-anytime-api.beisanytime.workers.dev';
    
    // 1. API for Community Feed (The new D1 Worker)
    const COMMUNITY_API_URL = 'https://beis-social-api.yourname.workers.dev'; // UPDATE THIS!
    
    // 2. API for Video Likes/Comments (The original KV Worker)
    const VIDEO_API_URL = 'https://beis-anytime-viewsapi.beisanytime.workers.dev';
    
    const ADMIN_EMAIL = 'beisanytime@gmail.com';
    const UPLOAD_PASSWORD = 'beis24/7';
    
    // --- State ---
    let allShiurimCache = [];
    let currentUser = null;
    let capturedThumbnailDataUrl = null;

    // --- DOM ---
    const contentArea = document.getElementById('app-content');
    const navItems = document.querySelectorAll('.nav-item, .bottom-nav-item');
    const themeToggle = document.getElementById('theme-toggle');

    // --- Helpers ---
    const applyTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        const icon = themeToggle.querySelector('i');
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    };

    const formatRabbiName = (id) => {
        if (!id) return 'Unknown';
        if (id.toLowerCase() === 'guests') return 'Guest Speakers';
        return id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    };

    const fetchMain = async (endpoint, options = {}) => {
        try {
            const res = await fetch(`${MAIN_API_URL}${endpoint}`, options);
            if (!res.ok) throw new Error('API Error');
            if (res.status === 204) return null;
            return await res.json();
        } catch (e) { console.error(e); return null; }
    };
    
    // Generic Fetcher for the two worker APIs
    const workerFetch = async (baseUrl, endpoint, options = {}) => {
        try {
            const res = await fetch(`${baseUrl}${endpoint}`, options);
            if (!res.ok) throw new Error('Worker Error');
            if (res.status === 204) return null;
            return await res.json();
        } catch (e) { return null; }
    };

    const getAllShiurim = async (force = false) => {
        if (allShiurimCache.length > 0 && !force) return allShiurimCache;
        const data = await fetchMain('/api/all-shiurim');
        if (data) {
            data.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            allShiurimCache = data;
        }
        return data;
    };

    // --- Components Renderers ---
    const renderEmptyState = (msg) => `
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h3>No Items Found</h3>
            <p style="color:var(--text-muted);">${msg}</p>
        </div>
    `;

    const renderVideoGrid = (videos, container) => {
        if (!videos || videos.length === 0) {
            container.innerHTML = renderEmptyState("Try checking back later.");
            return;
        }
        const frag = document.createDocumentFragment();
        videos.forEach(v => {
            const card = document.createElement('a');
            card.href = '#';
            card.className = 'video-card';
            card.dataset.shiurId = v.id;
            if (v.rabbi) card.setAttribute('data-rabbi', v.rabbi);

            const thumb = v.thumbnailDataUrl || v.thumbnailUrl || '';
            
            card.innerHTML = `
                <div class="thumb-wrapper">
                    <img data-src="${thumb}" class="thumb-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9' fill='%23f3f4f6'%3E%3C/svg%3E" alt="Thumbnail" loading="lazy">
                    <div class="rabbi-badge">
                        <span class="rabbi-dot"></span>
                        ${formatRabbiName(v.rabbi)}
                    </div>
                </div>
                <div class="card-content">
                    <h3 class="card-title">${v.title}</h3>
                    <span class="card-date">${v.date ? new Date(v.date).toLocaleDateString() : ''}</span>
                </div>
            `;
            frag.appendChild(card);
        });
        container.innerHTML = '';
        container.appendChild(frag);
        container.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
    };

    // --- Page Logic ---
    const pages = {
        home: async () => {
            const data = await getAllShiurim();
            if (!data) return;
            const recent = data.slice(0, 8);
            
            contentArea.innerHTML = `
                <section class="hero-card">
                    <h1>Torah Anytime, Anywhere.</h1>
                    <p style="max-width: 600px; font-size: 1.1rem; opacity: 0.8;">Explore a vast library of Shiurim from our esteemed Rabbis. Watch, listen, and grow.</p>
                    <div class="hero-actions">
                        <button class="btn btn-primary" onclick="loadPage('all')">Browse Library</button>
                    </div>
                </section>
                
                <h2 style="margin-bottom: 24px;">Latest Shiurim</h2>
                <div class="grid-videos"></div>
            `;
            renderVideoGrid(recent, contentArea.querySelector('.grid-videos'));
        },
        
        all: async () => {
            const data = await getAllShiurim();
            contentArea.innerHTML = `<h1 style="margin-bottom:30px;">All Shiurim</h1><div class="grid-videos"></div>`;
            renderVideoGrid(data, contentArea.querySelector('.grid-videos'));
        },

        community: async () => {
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
            
            contentArea.innerHTML = `
                <div class="feed-container">
                    <div style="margin-bottom:30px; display:flex; justify-content:space-between; align-items:center;">
                        <h1>Community Feed</h1>
                        <button class="btn btn-secondary" onclick="loadPage('community')"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                    
                    ${isAdmin ? `
                    <div class="post-composer">
                        <h3 style="margin-top:0; margin-bottom:12px; font-size:1rem;">Post Announcement</h3>
                        <div style="display:flex; gap:12px; margin-bottom:12px;">
                            <img src="${currentUser.picture}" style="width:40px; height:40px; border-radius:50%;">
                            <textarea id="postInput" placeholder="Write an official announcement..." style="flex:1; border:none; background:transparent; resize:none; font-size:1rem; outline:none;" rows="3"></textarea>
                        </div>
                        <div style="display:flex; justify-content:flex-end;">
                            <button id="postSubmitBtn" class="btn btn-primary">Post</button>
                        </div>
                    </div>
                    ` : `
                    <div style="margin-bottom:20px; padding:15px; background:var(--bg-surface-hover); border-radius:8px; border:1px solid var(--border-light); text-align:center; color:var(--text-muted); font-size:0.9rem;">
                        <i class="fas fa-bullhorn"></i> Official Announcements and Updates
                    </div>
                    `}
                    
                    <div id="postsList">
                        <div class="skeleton" style="height:150px; margin-bottom:20px;"></div>
                        <div class="skeleton" style="height:150px; margin-bottom:20px;"></div>
                    </div>
                </div>
            `;

            if (isAdmin) {
                document.getElementById('postSubmitBtn').onclick = async () => {
                    const txt = document.getElementById('postInput').value.trim();
                    if(!txt) return;
                    
                    const btn = document.getElementById('postSubmitBtn');
                    btn.disabled = true;
                    btn.textContent = "Posting...";

                    await workerFetch(COMMUNITY_API_URL, '/api/posts', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ content: txt, user: currentUser })
                    });
                    
                    loadPage('community'); 
                };
            }

            const posts = await workerFetch(COMMUNITY_API_URL, '/api/posts');
            const list = document.getElementById('postsList');
            
            if(!posts || !posts.length) {
                list.innerHTML = renderEmptyState("No announcements yet.");
                return;
            }

            list.innerHTML = posts.map(p => `
                <div class="post-card">
                    <div class="post-header">
                        <img src="${p.avatar_url}" class="post-avatar">
                        <div class="post-meta">
                            <span class="post-author">${p.display_name} <i class="fas fa-check-circle" style="color:var(--color-accent); font-size:0.8rem; margin-left:4px;" title="Verified Admin"></i></span>
                            <span class="post-time">${new Date(p.created_at * 1000).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="post-content">${p.content}</div>
                    ${(isAdmin) ? `
                        <div class="post-actions">
                             <button class="btn btn-secondary" style="color:red; font-size:0.8rem; padding:6px 12px;" onclick="deletePost(${p.id})">Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            window.deletePost = async (id) => {
                if(confirm('Delete post?')) {
                    await workerFetch(COMMUNITY_API_URL, `/api/posts/${id}`, { method: 'DELETE', headers: {'X-User-Email': currentUser.email} });
                    loadPage('community');
                }
            };
        },
        
        speakers: async () => {
            const speakers = [
                { id: 'Rabbi_Hartman', name: 'Rabbi Hartman', icon: 'fa-user-tie' },
                { id: 'Rabbi_Rosenfeld', name: 'Rabbi Rosenfeld', icon: 'fa-user-tie' },
                { id: 'Rabbi_Golker', name: 'Rabbi Golker', icon: 'fa-user-tie' },
                { id: 'guests', name: 'Guest Speakers', icon: 'fa-users' }
            ];
            
            contentArea.innerHTML = `<h1 style="margin-bottom:30px;">Speakers</h1><div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:24px;" id="speakerGrid"></div>`;
            
            const grid = document.getElementById('speakerGrid');
            speakers.forEach(s => {
                const el = document.createElement('a');
                el.href = '#';
                el.className = 'video-card';
                el.style.alignItems = 'center';
                el.style.padding = '40px';
                el.style.textAlign = 'center';
                el.setAttribute('data-rabbi', s.id);
                el.innerHTML = `
                    <div style="width:80px; height:80px; background:var(--bg-surface-hover); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:16px; font-size:2rem; color:var(--text-muted);">
                        <i class="fas ${s.icon}"></i>
                    </div>
                    <h3 style="margin:0;">${s.name}</h3>
                `;
                el.onclick = (e) => { e.preventDefault(); loadPage('speaker', {rabbi:s.id}); };
                grid.appendChild(el);
            });
        },
        
        speaker: async (params) => {
            const data = await getAllShiurim();
            const filtered = data.filter(s => s.rabbi && s.rabbi.toLowerCase() === params.rabbi.toLowerCase());
            contentArea.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h1>${formatRabbiName(params.rabbi)}</h1>
                    <p>${filtered.length} Shiurim available</p>
                </div>
                <div class="grid-videos"></div>
            `;
            renderVideoGrid(filtered, contentArea.querySelector('.grid-videos'));
        },
        
        view_shiur: async (params) => {
            const shiur = await fetchMain(`/api/shiurim/id/${params.id}`);
            if (!shiur) { contentArea.innerHTML = renderEmptyState("Shiur unavailable."); return; }
            
            contentArea.innerHTML = `
                <div style="max-width:1100px; margin:0 auto;">
                    <button class="btn btn-secondary" onclick="window.history.back()" style="margin-bottom:20px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    
                    <div class="video-container">
                        <video id="player-video" controls autoplay poster="${shiur.thumbnailDataUrl || ''}" src="${shiur.playbackUrl}" style="width:100%; height:100%;"></video>
                    </div>
                    
                    <div class="video-details">
                        <div class="flex-between" style="flex-wrap:wrap; gap:16px; margin-bottom:16px;">
                            <div>
                                <h1 style="font-size:1.5rem; margin-bottom:8px; color:var(--text-main);">${shiur.title}</h1>
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <span class="rabbi-badge" style="position:static; margin:0;">
                                        <span class="rabbi-dot"></span>${formatRabbiName(shiur.rabbi)}
                                    </span>
                                    <span style="color:var(--text-muted); font-size:0.9rem;">${new Date(shiur.date).toLocaleDateString()}</span>
                                    <span id="views-count" style="color:var(--text-muted); font-size:0.9rem; margin-left:8px; display:none;"><i class="fas fa-eye"></i> <span id="views-num">0</span></span>
                                </div>
                            </div>
                            <button id="likeBtn" class="btn btn-secondary">
                                <i class="far fa-thumbs-up"></i> <span id="likes-count" style="margin-left:6px;">0</span>
                            </button>
                        </div>
                        <p style="color:var(--text-muted); line-height:1.6;">${shiur.description || 'No description provided.'}</p>
                    </div>

                    <div class="video-comments-area">
                        <h2 style="font-size:1.2rem; margin-bottom:20px;">Comments</h2>
                        
                        ${currentUser ? `
                        <div class="comment-composer">
                            <div style="display:flex; gap:12px;">
                                <img src="${currentUser.picture}" class="comment-avatar">
                                <div style="flex:1;">
                                    <textarea id="commentInput" placeholder="Add a comment..." style="width:100%; border:1px solid var(--border-light); background:var(--bg-body); resize:none; font-size:0.9rem; outline:none; border-radius:8px; padding:10px;" rows="2"></textarea>
                                    <div style="text-align:right; margin-top:8px;">
                                        <button id="commentSubmitBtn" class="btn btn-primary" style="font-size:0.8rem; padding:6px 16px;">Post</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div style="padding:20px; text-align:center; color:var(--text-muted); border:1px dashed var(--border-light); border-radius:8px; margin-bottom:20px;">
                            Sign in to join the conversation.
                        </div>
                        `}

                        <div id="commentsList">
                            <div class="skeleton" style="height:60px; margin-bottom:12px;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // --- Logic for Video Interactions ---

            // 1. Views
            const getViews = async () => workerFetch(VIDEO_API_URL, `/api/views/${encodeURIComponent(params.id)}`);
            const viewRes = await getViews();
            if(viewRes && viewRes.count !== undefined) {
                 // Only show view count to admin as per previous logic, or everyone? User said "add back", previous was admin only in v8.
                 // Let's show to everyone for social feel.
                 document.getElementById('views-count').style.display = 'inline-block';
                 document.getElementById('views-num').textContent = viewRes.count;
            }

            const vid = document.getElementById('player-video');
            vid.addEventListener('play', () => {
                workerFetch(VIDEO_API_URL, '/api/views/increment', {
                    method:'POST', 
                    body:JSON.stringify({id:params.id}), 
                    headers:{'Content-Type':'application/json'}
                });
            }, {once:true});

            // 2. Likes
            const getLikes = async () => workerFetch(VIDEO_API_URL, `/api/likes/${encodeURIComponent(params.id)}`);
            const toggleLike = async () => {
                if(!currentUser) return alert('Please sign in');
                await workerFetch(VIDEO_API_URL, `/api/likes/${encodeURIComponent(params.id)}`, {
                    method:'POST', 
                    headers:{'X-User-Email':currentUser.email}
                });
            };
            
            const refreshLikes = async () => {
                const likeData = await getLikes();
                if(likeData) {
                    const btn = document.getElementById('likeBtn');
                    document.getElementById('likes-count').textContent = likeData.count;
                    if(likeData.userLiked) { 
                        btn.style.color = 'var(--color-accent)'; 
                        btn.querySelector('i').className = 'fas fa-thumbs-up'; 
                    } else {
                        btn.style.color = 'inherit'; 
                        btn.querySelector('i').className = 'far fa-thumbs-up';
                    }
                }
            };
            refreshLikes();
            
            document.getElementById('likeBtn').onclick = async function() {
                await toggleLike();
                refreshLikes();
            };

            // 3. Comments
            const getComments = async () => workerFetch(VIDEO_API_URL, `/api/comments/${encodeURIComponent(params.id)}`);
            
            const refreshComments = async () => {
                const res = await getComments();
                const list = document.getElementById('commentsList');
                list.innerHTML = '';
                
                if(!res || !res.comments || res.comments.length === 0) {
                    list.innerHTML = `<p style="color:var(--text-muted); font-size:0.9rem;">No comments yet.</p>`;
                    return;
                }

                list.innerHTML = res.comments.map(c => `
                    <div class="comment-item" style="padding:16px;">
                        <div class="comment-header" style="margin-bottom:8px;">
                            <div style="font-weight:700; font-size:0.9rem; color:var(--text-main);">${c.displayName || c.email}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${new Date(c.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div class="comment-text" style="font-size:0.95rem;">${c.text}</div>
                        ${(currentUser && currentUser.email === ADMIN_EMAIL) ? `
                            <button onclick="deleteComment('${c.id}')" style="background:none; border:none; color:red; font-size:0.75rem; cursor:pointer; margin-top:8px;">Delete</button>
                        ` : ''}
                    </div>
                `).join('');
            };

            if(currentUser) {
                document.getElementById('commentSubmitBtn').onclick = async () => {
                    const txt = document.getElementById('commentInput').value.trim();
                    if(!txt) return;
                    
                    await workerFetch(VIDEO_API_URL, `/api/comments/${encodeURIComponent(params.id)}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-User-Email': currentUser.email},
                        body: JSON.stringify({text: txt})
                    });
                    
                    document.getElementById('commentInput').value = '';
                    refreshComments();
                };
            }

            window.deleteComment = async (cid) => {
                if(confirm('Delete comment?')) {
                    await workerFetch(VIDEO_API_URL, `/api/comments/${encodeURIComponent(params.id)}/${cid}`, {
                        method: 'DELETE',
                        headers: {'X-User-Email': currentUser.email}
                    });
                    refreshComments();
                }
            };

            refreshComments();
        },

        admin: async () => {
            if (sessionStorage.getItem('uploadAuthorized') !== 'true') return renderPasswordModal('admin');
            const data = await fetchMain('/api/admin/shiurim');
            contentArea.innerHTML = `
                <div class="flex-between" style="margin-bottom:24px;">
                    <h1>Admin Dashboard</h1>
                    <button class="btn btn-primary" onclick="loadPage('upload')">Upload New</button>
                </div>
                <div style="background:var(--bg-surface-solid); border:1px solid var(--border-light); border-radius:12px; overflow:hidden;">
                    ${data && data.length ? data.map(s => `
                        <div style="padding:16px; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; gap:12px; align-items:center;">
                                <img src="${s.thumbnailDataUrl||''}" style="width:60px; height:34px; object-fit:cover; border-radius:4px;">
                                <div>
                                    <div style="font-weight:600;">${s.title}</div>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">${formatRabbiName(s.rabbi)}</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding:6px 12px; color:red; border-color:transparent;" data-del="${s.id}">Delete</button>
                        </div>
                    `).join('') : '<div style="padding:20px;">No shiurim.</div>'}
                </div>
            `;
            contentArea.querySelectorAll('[data-del]').forEach(b => {
                b.onclick = async () => {
                    if(confirm('Delete?')) {
                        await fetchMain(`/api/admin/shiurim/${b.dataset.del}`, {method:'DELETE'});
                        loadPage('admin');
                    }
                }
            });
        },

        upload: () => {
             if (sessionStorage.getItem('uploadAuthorized') !== 'true') return renderPasswordModal('upload');
             contentArea.innerHTML = `
                <div style="max-width:600px; margin:0 auto; background:var(--bg-surface-solid); padding:32px; border-radius:var(--radius-lg); border:1px solid var(--border-light);">
                    <h2 style="margin-bottom:24px;">Upload Shiur</h2>
                    <form id="upForm" style="display:grid; gap:16px;">
                        <div><label>Speaker</label><select id="rabbi"><option value="Rabbi_Hartman">Rabbi Hartman</option><option value="Rabbi_Rosenfeld">Rabbi Rosenfeld</option><option value="Rabbi_Golker">Rabbi Golker</option><option value="guests">Guest</option></select></div>
                        <div><label>Title</label><input type="text" id="title" required></div>
                        <div><label>Date</label><input type="date" id="date" required></div>
                        <div><label>File</label><input type="file" id="fInput" accept="video/*,audio/*" required></div>
                        <div id="prev" class="hidden"><video id="vidP" controls style="width:100%; border-radius:8px; margin-top:10px;"></video><button type="button" id="cap" class="btn btn-secondary" style="margin-top:8px;">Capture Thumb</button></div>
                        <button type="submit" class="btn btn-primary" id="sBtn">Upload</button>
                    </form>
                </div>
             `;
             const form = document.getElementById('upForm');
             const fInput = document.getElementById('fInput');
             const vidP = document.getElementById('vidP');
             
             fInput.onchange = (e) => {
                 if(e.target.files[0]) {
                     vidP.src = URL.createObjectURL(e.target.files[0]);
                     document.getElementById('prev').classList.remove('hidden');
                 }
             };
             
             document.getElementById('cap').onclick = () => {
                 const c = document.createElement('canvas');
                 c.width = vidP.videoWidth; c.height = vidP.videoHeight;
                 c.getContext('2d').drawImage(vidP,0,0);
                 capturedThumbnailDataUrl = c.toDataURL('image/jpeg', 0.8);
                 alert('Thumbnail Captured');
             };
             
             form.onsubmit = async (e) => {
                 e.preventDefault();
                 const btn = document.getElementById('sBtn');
                 btn.disabled = true; btn.textContent = 'Uploading...';
                 
                 try {
                     const file = fInput.files[0];
                     if(!capturedThumbnailDataUrl) throw new Error('Capture thumbnail first');
                     
                     const prep = await fetch(`${MAIN_API_URL}/api/admin/prepare-upload`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            title: document.getElementById('title').value,
                            rabbi: document.getElementById('rabbi').value,
                            date: document.getElementById('date').value,
                            thumbnailDataUrl: capturedThumbnailDataUrl,
                            fileName: file.name
                        })
                     });
                     const { signedUrl } = await prep.json();
                     
                     await fetch(signedUrl, { method: 'PUT', body: file });
                     alert('Uploaded');
                     loadPage('home');
                 } catch(err) { alert(err.message); btn.disabled = false; }
             };
        }
    };

    function renderPasswordModal(target) {
        contentArea.innerHTML = `
            <div style="max-width:400px; margin:60px auto; background:var(--bg-surface-solid); padding:30px; border-radius:var(--radius-md); border:1px solid var(--border-light); text-align:center;">
                <h3>Admin Access</h3>
                <input type="password" id="pwd" placeholder="Password" style="margin:16px 0;">
                <button id="pwdBtn" class="btn btn-primary">Unlock</button>
            </div>
        `;
        document.getElementById('pwdBtn').onclick = () => {
            if(document.getElementById('pwd').value === UPLOAD_PASSWORD) {
                sessionStorage.setItem('uploadAuthorized', 'true');
                loadPage(target);
            } else alert('Incorrect');
        };
    }

    // --- Routing & Transitions ---
    window.loadPage = (p, params) => {
        navItems.forEach(n => {
            n.classList.remove('active');
            if(n.dataset.page === p) n.classList.add('active');
        });

        const render = () => {
            document.body.setAttribute('data-page-context', p);
            window.scrollTo(0,0);
            if(pages[p]) pages[p](params || {});
            else pages.home();
        };

        if (document.startViewTransition) document.startViewTransition(() => render());
        else render();

        const hash = `${p}${params && params.id ? '/'+params.id : ''}`;
        window.history.replaceState(null, null, `#${hash}`);
    };

    // --- Events & Init ---
    themeToggle.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
    
    document.addEventListener('click', (e) => {
        const link = e.target.closest('[data-page]');
        if (link && !e.target.closest('.nav-item') && !e.target.closest('.bottom-nav-item')) { 
            e.preventDefault();
            loadPage(link.dataset.page);
        }
        
        const navItem = e.target.closest('.nav-item, .bottom-nav-item');
        if(navItem && navItem.dataset.page) {
            e.preventDefault();
            loadPage(navItem.dataset.page);
        }
        
        const card = e.target.closest('.video-card');
        if (card && card.dataset.shiurId) {
            e.preventDefault();
            loadPage('view_shiur', {id: card.dataset.shiurId});
        }
    });

    // Profile Dropdown Logic
    const pToggle = document.getElementById('profileToggle'); // Desktop
    const mProfile = document.getElementById('mobileProfileBtn'); // Mobile
    const globalMenu = document.getElementById('globalMenu');
    
    const toggleMenu = (e) => {
        e.stopPropagation();
        e.preventDefault();
        globalMenu.classList.toggle('active');
    };
    
    if(pToggle) pToggle.onclick = toggleMenu;
    if(mProfile) mProfile.onclick = toggleMenu;
    
    document.addEventListener('click', (e) => {
        if(!globalMenu.contains(e.target) && !mProfile.contains(e.target) && !pToggle.contains(e.target)) {
            globalMenu.classList.remove('active');
        }
    });
    
    document.getElementById('signOutBtn').onclick = () => { 
        localStorage.removeItem('googleUser'); 
        window.location.reload(); 
    };

    // Auth UI Update
    window.addEventListener('google-signin-success', (e) => {
        currentUser = e.detail;
        
        document.getElementById('desktop-auth-container').style.display = 'none';
        document.getElementById('profileDropdown').style.display = 'block';
        document.getElementById('userAvatar').src = currentUser.picture;

        document.getElementById('menuLoggedOut').style.display = 'none';
        document.getElementById('menuLoggedIn').style.display = 'block';
        document.getElementById('menuUserName').textContent = currentUser.name;
        
        if(currentUser.email === ADMIN_EMAIL) {
            document.getElementById('adminLink').style.display = 'flex';
            document.getElementById('uploadLink').style.display = 'flex'; 
        }
    });

    // Boot
    const storedUser = localStorage.getItem('googleUser');
    if(storedUser) window.dispatchEvent(new CustomEvent('google-signin-success', {detail: JSON.parse(storedUser)}));
    
    applyTheme(localStorage.getItem('theme') || 'light');
    
    const initialHash = window.location.hash.slice(1);
    const [page, param] = initialHash.split('/');
    loadPage(page || 'home', param ? {id: param} : {});
});
</script>
</body>
</html>
